{"version":3,"sources":["../src/stash-area.js"],"names":["define","$","Templates","Counselor","ItemDialogue","Drop","Trade","StashArea","node","_node","_setUp","prototype","_userItemTemplate","on","EVENT_PICKEDUP","_dropPickedUpListener","bind","EVENT_TRADE","_setUpUserItemAreClickable","addUserItem","userItem","_renderUserItem","then","html","js","container","find","data","_makeUserItemNodeClickable","append","runTemplateJS","containsItem","id","getUserItemNode","length","e","useritem","getItem","get","updateUserItemQuantity","remove","attr","render","item","getData","each","i","handler","currentTarget","itemId","dialogue","preventDefault","show","selector","delegate","keyCode","quantityNode","newQuantity","quantity","parseInt","text","removeClass","addClass"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Stash module.\n *\n * @package    block_stash\n * @copyright  2016 Frédéric Massart - FMCorz.net\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine([\n    'jquery',\n    'core/templates',\n    'block_stash/counselor',\n    'block_stash/item-dialogue',\n    'block_stash/drop',\n    'block_stash/trade'\n], function($, Templates, Counselor, ItemDialogue, Drop, Trade) {\n\n    /**\n     * Stash class.\n     *\n     * @class\n     * @param {Node} node The node.\n     */\n    function StashArea(node) {\n        this._node = $(node);\n        this._setUp();\n    }\n    StashArea.prototype._node = null;\n    StashArea.prototype._userItemTemplate = 'block_stash/user_item';\n\n    StashArea.prototype._setUp = function() {\n        Counselor.on(Drop.prototype.EVENT_PICKEDUP, this._dropPickedUpListener.bind(this));\n        Counselor.on(Trade.prototype.EVENT_TRADE, this._dropPickedUpListener.bind(this));\n\n        this._setUpUserItemAreClickable();\n    };\n\n    /**\n     * Add a user item to the stash.\n     *\n     * @param {UserItem} userItem The user item.\n     * @return {Promise}\n     */\n    StashArea.prototype.addUserItem = function(userItem) {\n        return this._renderUserItem(userItem).then(function(html, js) {\n            var node = $(html),\n                container = this._node.find('.item-list');\n            node.data('useritem', userItem);\n            this._makeUserItemNodeClickable(node);\n            container.append(' ');  // A hacky separator to replicate natural rendering.\n            container.append(node);\n            Templates.runTemplateJS(js);\n        }.bind(this));\n    };\n\n    /**\n     * Whether the item is in the stash.\n     *\n     * @param {Number} id The item ID.\n     * @return {Boolean}\n     */\n    StashArea.prototype.containsItem = function(id) {\n        return this.getUserItemNode(id).length > 0;\n    };\n\n    /**\n     * Listens to drop picked up events.\n     *\n     * @param {Event} e The event.\n     * @param {Object} data The event data.\n     */\n    StashArea.prototype._dropPickedUpListener = function(e, data) {\n        var userItem = data.useritem;\n        if (this.containsItem(userItem.getItem().get('id'))) {\n            this.updateUserItemQuantity(userItem);\n        } else {\n            this.addUserItem(userItem).then(function() {\n                this._node.find('.empty-content').remove();\n            }.bind(this));\n        }\n    };\n\n    /**\n     * Get the user item node.\n     *\n     * @param {Number} id The item ID.\n     * @return {Node}\n     */\n    StashArea.prototype.getUserItemNode = function(id) {\n        return this._node.find('.block-stash-item[data-id=' + id + ']');\n    };\n\n    /**\n     * Make a user item node clickable.\n     *\n     * @param {Node} node The node.\n     */\n    StashArea.prototype._makeUserItemNodeClickable = function(node) {\n        node.attr('tabindex', 0);\n        node.attr('role', 'button');\n        node.attr('aria-haspopup', 'true');\n    };\n\n    /**\n     * Render a user item.\n     *\n     * @param {UserItem} userItem The user item.\n     * @return {Promise}\n     */\n    StashArea.prototype._renderUserItem = function(userItem) {\n        return Templates.render(this._userItemTemplate, {\n            item: userItem.getItem().getData(),\n            useritem: userItem.getData(),\n        });\n    };\n\n    /**\n     * Set-up process to handle items being clickable.\n     */\n    StashArea.prototype._setUpUserItemAreClickable = function() {\n        // Make all items as clickable.\n        this._node.find('.item-list .block-stash-item').each(function(i, node) {\n            this._makeUserItemNodeClickable($(node));\n        }.bind(this));\n\n        // Delegate event.\n        var handler = function(e) {\n            var node = $(e.currentTarget),\n                itemId = node.data('id');\n\n            if (!itemId) {\n                return;\n            }\n\n            var dialogue = new ItemDialogue(itemId);\n            e.preventDefault();\n            dialogue.show(e);\n        };\n        var selector = '.block-stash-item[aria-haspopup=\"true\"]';\n        this._node.find('.item-list').delegate(selector, 'click', handler);\n        this._node.find('.item-list').delegate(selector, 'keydown', function(e) {\n            if (e.keyCode != 13 && e.keyCode != 32) {\n                return;\n            }\n            handler(e);\n        });\n    };\n\n    /**\n     * Update the quantity of a user item.\n     *\n     * @param {UserItem} userItem The user item.\n     */\n    StashArea.prototype.updateUserItemQuantity = function(userItem) {\n        var node = this.getUserItemNode(userItem.getItem().get('id')),\n            quantityNode = node.find('.item-quantity'),\n            newQuantity = userItem.get('quantity'),\n            quantity = parseInt(quantityNode.text(), 10);\n\n        quantityNode.text(newQuantity);\n        node.removeClass('item-quantity-' + quantity);\n        node.addClass('item-quantity-' + newQuantity);\n    };\n\n    return /** @alias module:block_stash/stash */ StashArea;\n\n});\n"],"file":"stash-area.min.js"}