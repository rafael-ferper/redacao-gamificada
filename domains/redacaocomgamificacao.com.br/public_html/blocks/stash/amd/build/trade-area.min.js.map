{"version":3,"sources":["../src/trade-area.js"],"names":["define","$","Templates","Counselor","Drop","notification","Trade","TradeArea","node","_node","_setUp","_update","prototype","on","EVENT_PICKEDUP","_dropPickedUpListener","bind","EVENT_TRADE","containsItem","id","getTradeItemNode","length","e","data","userItem","useritem","getItem","get","updateTradeItemUserQuantity","canTradeItems","removeditemnodes","find","hasenough","each","i","itemid","newQuantity","parseInt","quantity","attr","tradeid","parent","name","render","enoughitems","userquantity","done","html","js","replaceNodeContents","fail","exception","btn","first","prop"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Trade module.\n *\n * @package    block_stash\n * @copyright  2017 Adrian Greeve <adriangreeve.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine([\n    'jquery',\n    'core/templates',\n    'block_stash/counselor',\n    'block_stash/drop',\n    'core/notification',\n    'block_stash/trade',\n], function($, Templates, Counselor, Drop, notification, Trade) {\n\n    /**\n     * Trade class.\n     *\n     * @class\n     * @param {Node} node The node.\n     */\n    function TradeArea(node) {\n        this._node = $(node);\n        this._setUp();\n        this._update();\n    }\n    TradeArea.prototype._node = null;\n\n    /**\n     * Setup.\n     */\n    TradeArea.prototype._setUp = function() {\n        Counselor.on(Drop.prototype.EVENT_PICKEDUP, this._dropPickedUpListener.bind(this));\n        Counselor.on(Trade.prototype.EVENT_TRADE, this._dropPickedUpListener.bind(this));\n    };\n\n    /**\n     * Whether the item is in this trade area.\n     *\n     * @param {Number} id The item ID.\n     * @return {Boolean}\n     */\n    TradeArea.prototype.containsItem = function(id) {\n        return this.getTradeItemNode(id).length > 0;\n    };\n\n    /**\n     * Listens to drop picked up events.\n     *\n     * @param {Event} e The event.\n     * @param {Object} data The event data.\n     */\n    TradeArea.prototype._dropPickedUpListener = function(e, data) {\n        var userItem = data.useritem;\n        if (this.containsItem(userItem.getItem().get('id'))) {\n            this.updateTradeItemUserQuantity(userItem);\n        }\n    };\n\n    /**\n     * Can the user perform the trade?\n     *\n     * @return {Bool}\n     */\n    TradeArea.prototype.canTradeItems = function() {\n        var removeditemnodes = this._node.find('.removed-items');\n\n        var hasenough = true;\n        removeditemnodes.each(function(i, node) {\n            hasenough = hasenough && $(node).data('hasenough');\n        });\n\n        return hasenough;\n    };\n\n    /**\n     * Get the trade item node.\n     *\n     * @param {Number} id The item ID.\n     * @return {Node}\n     */\n    TradeArea.prototype.getTradeItemNode = function(id) {\n        return this._node.find('.removed-items[data-itemid=' + id + ']');\n    };\n\n    /**\n     * Update the quantity of a user item.\n     *\n     * @param {UserItem} userItem The user item.\n     */\n    TradeArea.prototype.updateTradeItemUserQuantity = function(userItem) {\n        var itemid = userItem.getItem().get('id'),\n            node = this.getTradeItemNode(itemid),\n            newQuantity = parseInt(userItem.get('quantity'), 10),\n            quantity = parseInt(node.attr('data-quantity'), 10),\n            tradeid = node.parent().attr('data-tradeid'),\n            name = userItem.getItem().get('name'),\n            enoughitems = (newQuantity >= quantity);\n\n        var context = {\n            enoughitems: enoughitems,\n            itemid: itemid,\n            quantity: quantity,\n            name: name,\n            userquantity: newQuantity\n        };\n\n        // I want to switch the template to show the new values.\n        Templates.render('block_stash/tradeitem_detail', context).done(function(html, js) {\n            Templates.replaceNodeContents($('.block-stash-trade-item-' + itemid + '[data-tradeid=\"' + tradeid + '\"]'), html, js);\n            this._update();\n        }.bind(this)).fail(notification.exception);\n    };\n\n    /**\n     * Update the widget.\n     *\n     * @return {Void}\n     */\n    TradeArea.prototype._update = function() {\n        var btn = this._node.find('.accept-trade button').first();\n        if (!btn) {\n            return;\n        }\n\n        if (!this.canTradeItems()) {\n            btn.prop('disabled', true);\n        } else {\n            btn.prop('disabled', false);\n        }\n    };\n\n    return /** @alias module:block_stash/trade-area */ TradeArea;\n\n});\n"],"file":"trade-area.min.js"}